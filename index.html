<!DOCTYPE html>

<html>

	<head>
		<meta charset="utf-8" />
		<script>

		function main() {
			
			//Create XML HTTP Request for interacting with REST interface
			let xhttp = new XMLHttpRequest();
			
			//When the XML document loads
			xhttp.onreadystatechange = function() {
				if(this.readyState == 4 && this.status == 200) {

					let xmlDoc = this.responseXML;

					let x = xmlDoc.getElementsByTagName("percent");
					//Set output field to the PWM percentage retrieved from the XML document
					document.getElementById("sliderValue").innerHTML = x[0].childNodes[0].nodeValue;

					x = xmlDoc.getElementsByTagName("frequency");
					//Set output field to the PWM frequency retrieved from the XML document
					document.getElementById("sliderFreqValue").innerHTML = x[0].childNodes[0].nodeValue;
					
					//Set output field to the temperature retrieved from the XML document
					x = xmlDoc.getElementsByTagName("temperature");
					document.getElementById("temperature").innerHTML = x[0].childNodes[0].nodeValue;
					
					//Set output field to the humidity retrieved from the XML document
					x = xmlDoc.getElementsByTagName("humidity");
					document.getElementById("humidity").innerHTML = x[0].childNodes[0].nodeValue;

				}

			}

			//Declare url and target it at the state.xml, the file which deals with the REST interface
			let url = "/state.xml";
			//Declare variable to count the number of parameters which need to be sent
			let varCount = 0;
			
			//Compute the desired PWM percentage based on slider and checkbox value
			let percentValue = (document.getElementById("invert").checked == false ? document.getElementById("slider").value : (100 - document.getElementById("slider").value))


			if(document.getElementById("sliderValue").innerHTML != percentValue) { //Only set if a change has been detected
				url += (varCount == 0 ? "?" : "&") + "percent=" + percentValue; //Append percent parameter to URL
				varCount += 1;
			}

			let frequencyValue = document.getElementById("sliderFreq").value;

			if(document.getElementById("sliderFreqValue").innerHTML != frequencyValue) { //Only set if a change has been detected
				url += (varCount == 0 ? "?" : "&") + "frequency=" + frequencyValue; //Append parameter to URL
				varCount += 1;
			}


			if(varCount != 0 || document.getElementById("continuous").checked == true) { //Only send request if a change has been made
				xhttp.open("GET", url, true);
				xhttp.send();
			}

			setTimeout(main, 300); //Call the main function again in 300 milliseconds, so that updates feel continuous
		}


		window.onload = main; //When the main page loads, ensure that the main functino is called

		</script>
	</head>

	<body>
		<h1>PWM Lighting Control</h1>
		<input type="range" min="0" max="100" value="50" id="slider">

		<p>Nominal PWM Value: <span id="sliderValue"></span>%</p>
		<p>Invert PWM: <input type="checkbox" id="invert">      Useful if output is inverted or if increasing duty cycle corresponds to decreasing output value</p>

		<h1> Frequency Control</h1>
		<input type="range" min="0" max="1000" value="100" id="sliderFreq">

		<p>Nominal Frequency Value: <span id="sliderFreqValue"></span> Hz</p>
		<p>Actual frequency is lower, due to delays.</p>
		
		<h1>Temperature</h1>
		<p>Temperature: <span id="temperature"></span>Â°C</p>
		
		<h1>Humidity</h1>
		<p>Humidity: <span id="humidity"></span>%</p>
		
		<p>Continuous refresh: <input type="checkbox" id="continuous"></p>
		<p>Enabling continuous refresh will cause the temperature and humidity values to update periodically.</p>
		<p>Disabling continuous refresh will cause the temperature and humidity values to update only when PWM duty cycle or frequency are altered. This saves bandwidth by reducing server requests.</p>
		
	</body>

</html>
